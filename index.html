<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>로고계좌타임</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
  authDomain: "mygps-11798.firebaseapp.com",
  projectId: "mygps-11798",
  storageBucket: "mygps-11798.firebasestorage.app",
  messagingSenderId: "271371741627",
  appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 1️⃣ 전역에서 letters 배열 선언
let letters = [];

// Firestore에서 글자 불러오기
async function loadLetters() {
  const q = query(collection(db, "letters"), orderBy("timestamp", "asc"));
  const snapshot = await getDocs(q);
  letters = snapshot.docs.map(doc => doc.data().text); // letters 배열 채움
  console.log("불러온 글자들:", letters);

  // 2️⃣ 불러온 후에 타이핑 함수 호출
  typing();
}

// Firestore 데이터 불러오기 시작
loadLetters();
</script>
<style>
  .typing {
    position: relative;
  }
  .brick {
    position: absolute;
    width: 12px;
    height: 12px;
    background: white;
    border: 1px solid black;
    border-radius: 3px;
    pointer-events: none;
    z-index: 9999;
    opacity: 1;
  }
  #time span {
    color: white;
    transition: color 5s ease;
  }
  .time-change {
    color: #FFC700 !important;
  }
</style>
</head>
<body>
  <br />
  <table border="0">
    <tr>
      <td width="975" style="vertical-align: top; text-align: right; white-space: nowrap; overflow: hidden; max-width: 975px; padding-left: 0px; padding-right: 85px;">
        <span class="typing" style="color: white; font-size: 45px; font-weight: bold; font-family: hy울릉도b; text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black, -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;">
          <span id="textcolor" class="text" style="white-space: pre;"></span>
        </span>
        <span style="color: white; font-size: 45px; font-weight: bold; font-family: hy울릉도b; text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black, -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;">
          <font color="#FFC700">&ensp;&ensp;&ensp;카카오</font> 33330-7696-7896 <font color="#6495ED">오J한</font>
        </span>
      </td>
      <td style="vertical-align: top; text-align: right; padding-top: 12px; padding-left: 50px;">
        <span id="time" style="color: white; font-size: 45px; font-weight: bold; font-family: hy울릉도b; text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black, -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;"></span>
      </td>
    </tr>
  </table>

<script>
  let typingLoopActive = true;
  let animationFrameId = null;

  function typing() {
    const $text = document.querySelector(".typing .text");

    const wordList = [
      { words: ["L", "후원", "구독", "감사", "다시", "YOON", "٩", "و"], color: "red" },
      { words: ["0","1","2","3","4","5","6","7","8","9",".","★","ᗜ","*"], color: "#FFC700" },
      { words: ["AGAIN"], color: "#6495ED" },
      { words: ["ㅡ"], color: "transparent" }
    ];

    const speed = 115;
    let i = 0;
    const wait = (ms) => new Promise(res => setTimeout(res, ms));

    const typingFunc = async () => {
      if (!typingLoopActive || letters.length === 0) return;

      $text.innerHTML = "";
      const raw = letters[i];
      const typingChars = [];
      const consumed = Array(raw.length).fill(false);

      for (const group of wordList) {
        for (const word of group.words) {
          let startIndex = 0;
          while (startIndex < raw.length) {
            const index = raw.indexOf(word, startIndex);
            if (index === -1) break;
            for (let j = 0; j < word.length; j++) {
              typingChars[index+j] = { char: word[j], color: group.color };
              consumed[index+j] = true;
            }
            startIndex = index + 1;
          }
        }
      }

      for (let j=0;j<raw.length;j++){
        if(!consumed[j]) typingChars[j] = {char: raw[j], color:"white"};
      }

      for (const {char,color} of typingChars){
        if(!typingLoopActive) return;
        await wait(speed);
        const span = document.createElement("span");
        span.textContent = char;
        span.style.color = color;
        if(color==="transparent") span.style.textShadow="none";
        $text.appendChild(span);
      }

      await wait(14000);
      reverseTyping();
    };

    const reverseTyping = async () => {
      const spans = Array.from($text.childNodes).reverse();
      for(let span of spans){
        if(!typingLoopActive) return;
        await new Promise(res=>setTimeout(res,speed));
        span.remove();
      }
      $text.innerHTML="";
      i=(i+1)%letters.length;
      typingFunc();
    };

    setTimeout(typingFunc,1000);
  }

  let prevTimeStr = "";
  let timeChangeTimeouts = [];

  function time() {
    const today = new Date();
    const hours = ("0"+today.getHours()).slice(-2);
    const minutes = ("0"+today.getMinutes()).slice(-2);
    const currentTimeStr = hours + ":" + minutes;

    const timeEl = document.getElementById("time");
    timeEl.innerHTML = "";

    timeChangeTimeouts.forEach(id=>clearTimeout(id));
    timeChangeTimeouts=[];

    for(let i=0;i<currentTimeStr.length;i++){
      const span=document.createElement("span");
      span.textContent=currentTimeStr[i];

      if(prevTimeStr && currentTimeStr[i]!==prevTimeStr[i]){
        span.classList.add("time-change");
        const timeoutId=setTimeout(()=>{span.classList.remove("time-change");},50);
        timeChangeTimeouts.push(timeoutId);
      }
      timeEl.appendChild(span);
    }

    prevTimeStr=currentTimeStr;
  }

  const timeInterval=setInterval(time,60000);

  window.addEventListener("beforeunload",function(){
    clearInterval(timeInterval);
    typingLoopActive=false;
    if(animationFrameId!==null) cancelAnimationFrame(animationFrameId);
  });

  window.onload=function(){time();};
</script>
</body>
</html>
