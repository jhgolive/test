<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>실시간 구글맵</title>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8swteRAgf-r_tS_uncv_IWJKcGghanrY&libraries=geometry"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
    authDomain: "mygps-11798.firebaseapp.com",
    databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mygps-11798",
    storageBucket: "mygps-11798.firebasestorage.app",
    messagingSenderId: "271371741627",
    appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map, marker, destinationMarker;
let addressDiv, distanceDiv;
let geocoder, directionsService;
let lastPosition = null;
let routePolyline = null;
let clickTimeout = null;
let routeDrawn = false; // ✅ 경로 한 번만 그리기용

// 다크모드 스타일
const darkModeStyle = [
  { elementType: "geometry", stylers: [{ color: "#212121" }] },
  { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
  { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
  { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] }
];

// 내 위치 마커
function createMarker(pos) {
    if (marker) marker.setMap(null);
    marker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
            url: "data:image/svg+xml;utf-8," + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="30" height="40"><polygon points="12,10 18,10 25,15 15,40 5,15" fill="red"/></svg>`),
            scaledSize: new google.maps.Size(30, 40)
        }
    });
}

// 목적지 마커
function createDestinationMarker(pos) {
    if (destinationMarker) destinationMarker.setMap(null);
    destinationMarker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
            url: "data:image/svg+xml;utf-8," + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="30" height="40"><polygon points="12,10 18,10 25,15 15,40 5,15" fill="blue"/></svg>`),
            scaledSize: new google.maps.Size(30, 40)
        }
    });
}

// 주소 div
function createAddressDiv() {
    if (!addressDiv) {
        addressDiv = document.createElement("div");
        addressDiv.style.fontSize = "20px";
        addressDiv.style.fontWeight = "900";
        addressDiv.style.textAlign = "center";
        addressDiv.style.width = "300px";
        addressDiv.style.whiteSpace = "nowrap";
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(addressDiv);
    }
}

// 거리 div
function createDistanceDiv() {
    if (!distanceDiv) {
        distanceDiv = document.createElement("div");
        distanceDiv.style.fontSize = "16px";
        distanceDiv.style.fontWeight = "bold";
        distanceDiv.style.textAlign = "center";
        distanceDiv.style.width = "120px";
        distanceDiv.style.whiteSpace = "nowrap";
        map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(distanceDiv);
    }
}

// 거리 업데이트
function updateDistanceText(distanceMeters) {
    if (!distanceDiv) return;
    let text = distanceMeters >= 1000 ? (distanceMeters/1000).toFixed(2) + " km" : Math.round(distanceMeters) + " m";
    distanceDiv.innerText = text;
}

// 경로 그리기 (한 번만)
function drawFlexibleRoute(start, end) {
    if (routePolyline) routePolyline.setMap(null);
    const directionsService = new google.maps.DirectionsService();
    directionsService.route({
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING
    }, (result, status) => {
        if (status === "OK" && result.routes.length > 0) {
            const path = result.routes[0].overview_path;
            routePolyline = new google.maps.Polyline({
                path: path,
                map: map,
                strokeColor: "#4285F4",
                strokeOpacity: 1.0,
                strokeWeight: 5
            });
            const dist = result.routes[0].legs[0].distance.value;
            updateDistanceText(dist);
            routeDrawn = true;
        }
    });
}

window.onload = function() {
    const container = document.getElementById("map");
    map = new google.maps.Map(container, {
        center: {lat: 37.5665, lng: 126.9780},
        zoom: 14,
        disableDefaultUI: true,
        styles: darkModeStyle
    });

    createAddressDiv();
    createDistanceDiv();
    geocoder = new google.maps.Geocoder();

    const locRef = ref(db, "location/current");
    const destRef = ref(db, "location/destination");

    // 내 위치 실시간 갱신
    onValue(locRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        const pos = {lat: data.lat, lng: data.lng};
        if (!marker) createMarker(pos);
        else marker.setPosition(pos);
        map.setCenter(pos);
        if (destinationMarker && !routeDrawn) drawFlexibleRoute(pos, destinationMarker.getPosition().toJSON());
    });

    // 클릭 & 더블클릭
    map.addListener("click", (e) => {
        if (clickTimeout) return;
        clickTimeout = setTimeout(() => {
            clickTimeout = null;
            if (destinationMarker) {
                set(destRef, null);
                if (routePolyline) routePolyline.setMap(null);
                distanceDiv.innerText = "";
                routeDrawn = false;
            } else {
                set(destRef, {lat: e.latLng.lat(), lng: e.latLng.lng()});
            }
        }, 250);
    });

    map.addListener("dblclick", () => {
        if (clickTimeout) {
            clearTimeout(clickTimeout);
            clickTimeout = null;
        }
    });

    // 목적지 실시간 갱신
    onValue(destRef, (snapshot) => {
        const dest = snapshot.val();
        if (!dest) {
            if (destinationMarker) destinationMarker.setMap(null);
            destinationMarker = null;
            if (routePolyline) routePolyline.setMap(null);
            distanceDiv.innerText = "";
            routeDrawn = false;
            return;
        }
        const destPos = {lat: dest.lat, lng: dest.lng};
        if (!destinationMarker) createDestinationMarker(destPos);
        else destinationMarker.setPosition(destPos);
        if (!routeDrawn && marker) drawFlexibleRoute(marker.getPosition().toJSON(), destPos);
    });
};
</script>
<style>
body { margin:0; padding:0; min-height:100vh; }
#map { width:200px; height:200px; border:1px solid #000; border-radius:0px; position:absolute; top:0; right:0; }
</style>
</head>
<body>
<div id="map"></div>
</body>
</html>
