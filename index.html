<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>타이핑 효과</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
  authDomain: "mygps-11798.firebaseapp.com",
  projectId: "mygps-11798",
  storageBucket: "mygps-11798.firebasestorage.app",
  messagingSenderId: "271371741627",
  appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Firestore에서 데이터 불러오기
async function loadLettersFromFirestore() {
  const q = query(collection(db, "letters"), orderBy("timestamp", "asc"));
  const snapshot = await getDocs(q);
  const letters = snapshot.docs.map(doc => doc.data().text);

  console.log("Firestore에서 불러온 letters:", letters);
  typing(letters);
}

// 타이핑 함수
function typing(letters) {
  const $text = document.querySelector(".typing .text");

  const wordList = [
    { words: ["L", "후원", "구독", "감사", "다시", "YOON", "٩", "و"], color: "red" }, 
    { words: ["0","1","2","3","4","5","6","7","8","9",".","★","ᗜ","*"], color: "#FFC700" }, 
    { words: ["AGAIN"], color: "#6495ED" }, 
    { words: ["ㅡ"], color: "transparent" } 
  ];

  const speed = 115;
  let i = 0;

  const wait = (ms) => new Promise(res => setTimeout(res, ms));

  const typingFunc = async () => {
    $text.innerHTML = "";
    const raw = letters[i];
    const typingChars = [];
    const consumed = Array(raw.length).fill(false);

    // 색상 처리
    for (const group of wordList) {
      for (const word of group.words) {
        let startIndex = 0;
        while (startIndex < raw.length) {
          const index = raw.indexOf(word, startIndex);
          if (index === -1) break;
          for (let j = 0; j < word.length; j++) {
            typingChars[index + j] = { char: word[j], color: group.color };
            consumed[index + j] = true;
          }
          startIndex = index + 1;
        }
      }
    }

    for (let j = 0; j < raw.length; j++) {
      if (!consumed[j]) {
        typingChars[j] = { char: raw[j], color: "white" };
      }
    }

    // 실제 타이핑
    for (const { char, color } of typingChars) {
      await wait(speed);
      const span = document.createElement("span");
      span.textContent = char;
      span.style.color = color;
      if (color === "transparent") span.style.textShadow = "none";
      $text.appendChild(span);
    }

    await wait(14000);
    i = (i + 1) % letters.length;
    typingFunc();
  };

  typingFunc();
}

// 실행
window.onload = function () {
  loadLettersFromFirestore();
};
</script>
<style>
  .typing {
    position: relative;
  }
  .typing .text {
    white-space: pre;
  }
</style>
</head>
<body>
  <br />
  <table border="0">
    <tr>
      <td width="975" style="vertical-align: top; text-align: right; white-space: nowrap; overflow: hidden; max-width: 975px; padding-left: 0px; padding-right: 85px;">
        <span class="typing" style="color: white; font-size: 45px; font-weight: bold; font-family: hy울릉도b; text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black, -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;">
          <span id="textcolor" class="text"></span>
        </span>
        <span style="color: white; font-size: 45px; font-weight: bold; font-family: hy울릉도b; text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black, -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;">
          <font color="#FFC700">&ensp;&ensp;&ensp;카카오</font> 33330-7696-7896 <font color="#6495ED">오J한</font>
        </span>
      </td>
      <td style="vertical-align: top; text-align: right; padding-top: 12px; padding-left: 50px;">
        <span id="time" style="color: white; font-size: 45px; font-weight: bold; font-family: hy울릉도b; text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black, -2px -2px black, -2px 2px black, 2px -2px black, 2px 2px black;"></span>
      </td>
    </tr>
  </table>
</body>
</html>
